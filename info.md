### ElasticSearch для всех



1. [История развития СУБД](#introduction)
2. [Инструменты для взаимодействия с СУБД](#tooling)
3. [Какой database engine используется в вашей СУБД?](#database_engine)
4. [Как устроен язык запросов в вашей СУБД? Разверните БД с данными и выполните ряд запросов.](#queries)
5. [Возможно ли распределение файлов БД по разным носителям?](#distribution)
6. [На каком языке/ах программирования написана СУБД?](#lang)
7. [Какие типы индексов поддерживаются в БД? Приведите пример создания индексов.](#indexes)
8. [Как строится процесс выполнения запросов в вашей СУБД?](#query_processing)
9. [Есть ли для вашей СУБД понятие «план запросов»? Если да, объясните, как работает данный этап.](#query_plan)
10. [Поддерживаются ли транзакции в вашей СУБД? Если да, то расскажите о нем. Если нет, то существует ли альтернатива?](#transactions)
11. [Какие методы восстановления поддерживаются в вашей СУБД. Расскажите о них.](#recover)
12. [Расскажите про шардинг в вашей конкретной СУБД. Какие типы используются? Принцип работы.](#sharding)
13. [Возможно ли применить термины Data Mining, Data Warehousing и OLAP в вашей СУБД?](#olap)
14. [Какие методы защиты поддерживаются вашей СУБД? Шифрование трафика, модели авторизации и т.п.](#secure)
15. [Какие сообщества развивают данную СУБД? Кто в проекте имеет права на коммит и создание дистрибутива версий? Расскажите об этих людей и/или компаниях.](#community)
16. [Создайте свои собственные данные для демонстрации работы СУБД.](#generate_data)
17. [Как продолжить самостоятельное изучение языка запросов с помощью демобазы. Если демобазы нет, то создайте ее.](#demobase)
18. [Где найти документацию и пройти обучение](#docs)
19. [Как быть в курсе  происходящего](#introduction)

## История развития СУБД <a id="events"></a>

В 2004 году Шай Бейнон (Shay Banon) создал предшественника Elasticsearch — систему Compass. Разрабатывая третью версию Compass, Бейнон пришёл к выводу, что для создания масштабируемой версии системы, необходимо создавать программу «с нуля», в результате в феврале 2010 года была выпущена первая версия Elasticsearch.

Для коммерциализации проекта Бейнон в 2012 году основал нидерландскую компанию Elasticsearch BV. В июне 2014 года компания объявила о привлечении $70 млн в рамках цикла финансирования серии C, отбор проходил под руководством New Enterprise Associates (NEA), дополнительными спонсорами стали Benchmark Capital и Index Ventures, в результате раунд принёс фирме общее финансирование $104 млн.

В марте 2015 года компания Elasticsearch изменила свое название на Elastic.

[source](https://www.elastic.co/about/history-of-elasticsearch)  
[wikipedia](https://ru.wikipedia.org/wiki/Elasticsearch)

## Инструменты для взаимодействия с СУБД <a id="tooling"></a>

Есть клиенты на все популярные языки. Но обучно это просто оболочки REST API

Визуализация данных: Kibana
![Кибана из демо](/images/kibana.png)


## 3. Какой database engine используется в вашей СУБД? <a id="database_engine"></a>

Apache Lucene - базовый кирпичик Elasticsearch.  
По-сути, Elasticsearch - распределенный Apache Lucene с удобным синтаксисом, блэкджеком и индексами.

![Устройство кластера Elasticsearch](/images/elasticsearchcluster.png)


- Кластер. Кластер Elasticsearch состоит из одного или нескольких узлов Elasticsearch, который является аналогом таблицы в реляционной базе данных.
- Нода. Экземпляр Elasticsearch.
- Документ. Единица информации, которая может быть проиндексирована.
- Индекс. Каждый документ в Elasticsearch хранится в индексе. Индекс логически группирует документы, а также предоставляет параметры конфигурации, связанные с масштабируемостью и доступностью.
- Маппинг. Подобно схеме в мире реляционных баз данных, сопоставление определяет различные типы, которые находятся внутри индекса. У нас есть индекс, в котором хранятся все данные. И есть маппинг, в котором хранится вся метаинформация об индексе. Какая структура, какие валидаторы, какие типы данных, как он будет их хранить и индексировать.
- Шарды. Все индексы подразделяются на небольшие фрагменты, называемые шардами. Каждый сегмент сам по себе является полноценным, независимым индексом Lucene, который может быть расположен на любом узле кластера. Проще говоря, Шарды - это единый индекс Lucene.
- Реплики. Реплики, как следует из названия, являются отказоустойчивыми механизмами Elasticsearch и представляют собой копии шардов вашего индекса.
- Сегмент. Каждый шард содержит несколько “сегментов”, где сегмент является инвертированным индексом. Поиск в сегменте будет выполнять поиск по каждому сегменту по очереди, а затем объединять их результаты в окончательные результаты для этого шарда. Запросы распараллеливаются по шардам индекса, что повышает производительность поиска и пропускную способность.


## 4. Как устроен язык запросов в вашей СУБД? Разверните БД с данными и выполните ряд запросов. <a id="queries"></a>

- API документов: CRUD (Create Retrieve Update Delete) операции с документами
- API поиска: поиск чего бы то ни было - используется DSL (Domain specific Language) 
- API Индексов: управление индексами (создание, удаление …)
- API Cat: вместо JSON данных возвращаются в табличном виде
- API кластера: для управления кластером

### TODO - сделать демо в докере


## 5. Возможно ли распределение файлов БД по разным носителям? <a id="distribution"></a>

- Можно использовать несколько дисковых томов для хранения индекса. [proof](https://stackoverflow.com/questions/43947045/using-two-different-disk-volumes-to-store-elasticsearch)

- Можно создать кластер Elasticsearch c на нескольких нодах (мастер и дата-ноды)
- Можно реплицировать данные на разные ноды
- Можно шардировать данные на разные ноды


## 6. На каком языке/ах программирования написана СУБД? <a id="lang"></a>

На Java. Только)

## 7. Какие типы индексов поддерживаются в БД? Приведите пример создания индексов. <a id="indexes"></a>

### TODO - сделать демо в докере

Главная сущность - инвертированный индекс. Это структура данных, в которой для каждого слова коллекции документов в соответствующем списке перечислены все документы в коллекции, в которых оно встретилось. Инвертированный индекс используется для поиска по текстам. 


Обычный индекс
![Обычный индекс](/images/index.png)


Инвертированный индекс
![Обычный индекс](/images/inverted_index.png)

## 8. Как строится процесс выполнения запросов в вашей СУБД? <a id="query_processing"></a>


Классический полнотекстовый match запрос

- Запрос отправляется во все ноды с primary шардами
- На шардах запрос преобразуется с помощью анализаторов в синтаксис запросов Apach Lucene индекса(Это булевая функция по вхождению и подсчета статистики токенов в документы индекса)
- Результаты сегмента объединяются
- Результаты шардов объединяются и возвращаются клиенту


## 9. Есть ли для вашей СУБД понятие «план запросов»? Если да, объясните, как работает данный этап. <a id="query_plan"></a>

Плана запросов, как в SQL БД, как такого нет

Но есть интересные помошники разработчику

[Explain API](https://www.elastic.co/guide/en/elasticsearch/reference/current/search-explain.html)
Вычисляет объяснение оценки для запроса и конкретного документа. Это может дать полезную обратную связь о том, соответствует ли документ конкретному запросу или нет.


[Profile Api](https://www.elastic.co/guide/en/elasticsearch/reference/current/search-profile.html)
Предоставляет подробную информацию о сроках выполнения отдельных компонентов в поисковом запросе. Это дает пользователю представление о том, как поисковые запросы выполняются на низком уровне, чтобы пользователь мог понять, почему определенные запросы выполняются медленно, и предпринять шаги по их улучшению.

## 10. Поддерживаются ли транзакции в вашей СУБД? Если да, то расскажите о нем. Если нет, то существует ли альтернатива? <a id="transactions"></a>

Под капотом Elasticsearch использует Apache Lucene и в нем есть концепция транзакций. В Elasticsearch нет понятия транзакций в обычном смысле этого слова. Если вы отправили документ, откат больше невозможен.

Elasticsearch имеет механизм **write-ahead log**, чтобы обеспечить надежность сохранения документов без необходимости фиксации на стороне Apache Lucene, поскольку это дорогостоящая операция.

Elasticsearch может указать уровень согласованности операций индексирования с точки зрения количества реплик, которые должны подтвердить операцию перед возвратом ответа клиенту. По умолчанию используется кворум, который равен [n/2] + 1.

Вместо транзакций используется [**Optimistic concurrency control**](https://www.elastic.co/guide/en/elasticsearch/reference/current/optimistic-concurrency-control.html)

Чтобы гарантировать, что более старая версия документа не перезапишет более новую версию, каждой операции, выполняемой с документом, primary_shard присваивает порядковый номер, который координирует это изменение.
Порядковый номер увеличивается с каждой операцией, и, таким образом, новые операции гарантированно будут иметь более высокий порядковый номер, чем более старые операции. Затем Elasticsearch может использовать порядковый номер операций, чтобы убедиться, что более новая версия документа никогда не будет переопределена изменением, которому присвоен меньший порядковый номер.



## 11. Какие методы восстановления поддерживаются в вашей СУБД. Расскажите о них. <a id="recover"></a>

**Translog**

Когда документ индексируется, он добавляется в **in-memory buffer** и добавляется к translog

Каждую секунду шард обновляется:

- Документы из **in-memory buffer** записываются в новый сегмент.

- Сегмент открывается, чтобы сделать его видимым для поиска.

- Буфер в памяти очищается.

Когда транслог становится слишком большим — индекс сбрасывается; создается новый транслог и выполняется полная фиксация:

- Все документы, хранящиеся в in-memory buffer, записываются в новый сегмент.

- In-memory buffer очищается.

- **Сommit point** записывается на диск.

- Кэш файловой системы очищается с помощью fsync.

- Старый транслог удаляется.

**Сommit point** используются для восстановления данных с диска при запуске Elasticsearch.

## 12. Расскажите про шардинг в вашей конкретной СУБД. Какие типы используются? Принцип работы. <a id="sharding"></a>

Шардинг используется для параллельности вычислений и обновлений. 

Шард определяется по формуле **shard = hash(routing) % number_of_primary_shards**, где routing - некая строка документа, обычно id. Но вы можете routing сделать по геолокации или версии.

## 13. Возможно ли применить термины Data Mining, Data Warehousing и OLAP в вашей СУБД? <a id="olap"></a>


## 14. Какие методы защиты поддерживаются вашей СУБД? Шифрование трафика, модели авторизации и т.п. <a id="secure"></a>


## 15. Какие сообщества развивают данную СУБД? Кто в проекте имеет права на коммит и создание дистрибутива версий? Расскажите об этих людей и/или компаниях. <a id="community"></a>

[Официальное сообщество](https://www.elastic.co/community/)  
[Русское сообщество в телеграмме](https://t.me/elasticsearch_ru)

До версии 8.0.0 - ElasticSearch был полный opensource(ALv2). 
Взамен Elastic выпускает Elasticsearch и Kibana с исходным кодом, доступным под лицензией Elastic или Server Side Public License (SSPL). Т.е. запрет на использование продукта как DBaaS.

Но появился проект OpenSearch - форк от amazon 7 версии ElasticSearch, где остался opensource(ALv2) и поддерживаются все изменения ElasticSearch 8.0.0


## 16. Создайте свои собственные данные для демонстрации работы СУБД.  <a id="generate_data"></a>

В папке /demo/data

## 17. Как продолжить самостоятельное изучение языка запросов с помощью демобазы. Если демобазы нет, то создайте ее. <a id="demobase"></a>

Есть https://www.elastic.co/demos, там много примеров настройки.

- Классическая задача: построить систему хранения/поиска логов. Можно ее решить и поднимать планку качества инфраструктуры.

- Разобратьсяв полнотекстовом поиске: сравнить поиск по нграммам и со лематизаторами.  

## 18. Где найти документацию и пройти обучение   <a id="docs"></a>
[Официальная документация](https://www.elastic.co/guide/en/elasticsearch/reference/current/index.html)

[codedzen.ru](https://codedzen.ru/elasticsearch-vvedeniye-1-2-vzaimodeystviye/)

[Хорошая статья на хабре](https://habr.com/ru/articles/717518/)

## 19. Как быть в курсе  происходящего <a id="events"></a>

Читать официальную документацию, участвовать в [конференциях](https://www.elastic.co/events/).
